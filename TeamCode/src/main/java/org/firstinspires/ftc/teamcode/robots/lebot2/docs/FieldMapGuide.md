# FieldMap Guide

A quick reference for defining waypoints and building autonomous trajectories.

---

## Adding New Waypoints

### Step 1: Add to RED_WAYPOINTS map

Open `FieldMap.java` and add your waypoint in the `static` block:

```java
static {
    // ... existing waypoints ...

    // Add your new waypoint (RED alliance coordinates)
    RED_WAYPOINTS.put("MY_NEW_WAYPOINT", new Waypoint(24.0, -48.0, 135.0));
    //                                               x(in)  y(in)  heading(deg)
}
```

**Coordinate system (DECODE):**
- X+ toward audience
- Y- is red side, Y+ is blue side
- Heading 0° = facing audience, 90° = facing blue wall, -90° = facing red wall

### Step 2: Add a constant (optional but recommended)

At the bottom of `FieldMap.java`, add a constant to avoid typos:

```java
public static final String MY_NEW_WAYPOINT = "MY_NEW_WAYPOINT";
```

### Step 3: Use it

```java
Pose2d pose = FieldMap.getPose(FieldMap.MY_NEW_WAYPOINT, Robot.isRedAlliance);
```

The blue alliance version is auto-generated by reflecting across the X axis.

**Note on ball row waypoints:** Due to asymmetric intake design, all `BALL_ROW_*` waypoints automatically get a +6" X offset when reflected for blue alliance. This is handled automatically in `get()` - just define the red waypoints and the offset is applied. To adjust the offset, change `BALL_ROW_BLUE_X_OFFSET` in `FieldMap.java`.

---

## Quick Runtime Additions

For testing without recompiling:

```java
// Add a temporary waypoint
FieldMap.addWaypoint("TEST_POINT", 36.0, -24.0, 90.0);

// Use it immediately
Pose2d testPose = FieldMap.getPose("TEST_POINT", true);
```

---

## Building Trajectories (Tank Drive)

Tank drive can only move forward/backward and turn in place - no lateral movement. This limits the available trajectory methods.

### Available Methods

| Method | Parameters | Description |
|--------|------------|-------------|
| `lineToX(x)` | x coordinate | Drive forward/backward until X equals target |
| `lineToY(y)` | y coordinate | Drive forward/backward until Y equals target |
| `turnTo(heading)` | radians | Turn in place to face heading |
| `splineTo(pos, tangent)` | Vector2d, radians | Curved path to position, heading follows path |

**Notes:**
- `lineToX` and `lineToY` drive in a straight line - the robot must already be facing the correct direction.
- `splineTo` works because the robot heading follows the path tangent (natural for tank drive).
- `splineToConstantHeading` and `splineToLinearHeading` do NOT work - they require lateral motion.

### Basic Movement - Drive Along an Axis

```java
Pose2d start = FieldMap.getPose(FieldMap.START_AUDIENCE, Robot.isRedAlliance);
Pose2d fire1 = FieldMap.getPose(FieldMap.FIRE_1, Robot.isRedAlliance);

// Drive forward/backward to reach target X coordinate
Action driveToX = driveTrain.actionBuilder(start)
    .lineToX(fire1.position.x)
    .build();

// Drive forward/backward to reach target Y coordinate
Action driveToY = driveTrain.actionBuilder(start)
    .lineToY(fire1.position.y)
    .build();
```

### Turn Then Drive - Reaching an (x, y) Position

To reach an arbitrary (x, y) position with tank drive, turn to face the target first, then drive. Use `FieldMap.bearingTo()` to calculate the heading:

```java
Pose2d target = FieldMap.getPose(FieldMap.FIRE_1, Robot.isRedAlliance);

Action driveToTarget = driveTrain.actionBuilder(currentPose)
    .turnTo(FieldMap.bearingTo(currentPose, target))  // Face the target
    .lineToX(target.position.x)                        // Drive to it
    .turnTo(target.heading)                            // Turn to final heading
    .build();
```

### Multi-Waypoint Sequence

```java
Pose2d start = FieldMap.getPose(FieldMap.START_AUDIENCE, Robot.isRedAlliance);
Pose2d fire1 = FieldMap.getPose(FieldMap.FIRE_1, Robot.isRedAlliance);
Pose2d ballRow1 = FieldMap.getPose(FieldMap.BALL_ROW_1_START, Robot.isRedAlliance);
Pose2d ballRow1End = FieldMap.getPose(FieldMap.BALL_ROW_1_END, Robot.isRedAlliance);
Pose2d fire2 = FieldMap.getPose(FieldMap.FIRE_2, Robot.isRedAlliance);

Action sequence = driveTrain.actionBuilder(start)
    // Drive to first fire position
    .lineToX(fire1.position.x)
    .turnTo(fire1.heading)             // Face goal
    .stopAndAdd(launchAction)          // Fire balls

    // Turn toward ball row, drive to it
    .turnTo(ballRow1.heading)
    .lineToX(ballRow1.position.x)

    // Drive through ball row (collecting balls)
    .lineToX(ballRow1End.position.x)

    // Return to fire position
    .turnTo(fire2.heading)
    .lineToX(fire2.position.x)
    .stopAndAdd(launchAction)          // Fire again

    .build();
```

### Turn in Place

```java
Waypoint wp = FieldMap.get(FieldMap.FIRE_1, Robot.isRedAlliance);

// Turn to the waypoint's heading (convert degrees to radians)
Action turn = driveTrain.actionBuilder(currentPose)
    .turnTo(Math.toRadians(wp.heading))
    .build();

// Or use Pose2d directly (heading already in radians)
Pose2d firePose = FieldMap.getPose(FieldMap.FIRE_1, Robot.isRedAlliance);
Action turn2 = driveTrain.actionBuilder(currentPose)
    .turnTo(firePose.heading)
    .build();
```

### Spline - Curved Path

Use `splineTo()` for smooth curved paths. The robot heading automatically follows the path tangent (natural for tank drive).

```java
Pose2d start = FieldMap.getPose(FieldMap.START_GOAL, Robot.isRedAlliance);
Pose2d fire1 = FieldMap.getPose(FieldMap.FIRE_1, Robot.isRedAlliance);

// Curved path to target - tangent is the direction the path is traveling at arrival
Action curvedPath = driveTrain.actionBuilder(start)
    .splineTo(fire1.position, fire1.heading)  // Arrive traveling in fire1's heading direction
    .build();

// Chain splines for smooth multi-waypoint curves
Pose2d ballRow1 = FieldMap.getPose(FieldMap.BALL_ROW_1_START, Robot.isRedAlliance);

Action smoothSequence = driveTrain.actionBuilder(start)
    .splineTo(fire1.position, fire1.heading)
    .stopAndAdd(launchAction)
    .splineTo(ballRow1.position, ballRow1.heading)
    .build();
```

**When to use splines vs lines:**
- **Lines** (`lineToX`/`lineToY`): Simple, predictable, requires turn-then-drive pattern
- **Splines**: Smooth curves, avoids stopping to turn, looks cleaner

---

## Common Patterns

### Drive to Position and Rotate

```java
Pose2d target = FieldMap.getPose(FieldMap.FIRE_1, Robot.isRedAlliance);

// Tank drive: drive to X, then turn to final heading
Action driveAndTurn = driveTrain.actionBuilder(currentPose)
    .lineToX(target.position.x)
    .turnTo(target.heading)
    .build();
```

### Ball Collection Run

```java
Pose2d rowStart = FieldMap.getPose(FieldMap.BALL_ROW_1_START, Robot.isRedAlliance);
Pose2d rowEnd = FieldMap.getPose(FieldMap.BALL_ROW_1_END, Robot.isRedAlliance);

Action collectBalls = driveTrain.actionBuilder(currentPose)
    // Turn to face the row, drive to start
    .turnTo(rowStart.heading)
    .lineToX(rowStart.position.x)

    // Drive through the row (intake runs during this)
    .lineToX(rowEnd.position.x)
    .build();
```

### Return to Homebase

```java
Pose2d home = FieldMap.getPose(FieldMap.HOMEBASE, Robot.isRedAlliance);

Action goHome = driveTrain.actionBuilder(currentPose)
    .turnTo(home.heading)          // Face home direction
    .lineToX(home.position.x)      // Drive there
    .build();
```

---

## Tips

1. **Measure waypoints with the robot** - Drive to position manually, read pose from telemetry, copy values to FieldMap.

2. **Test one waypoint at a time** - Verify each waypoint is correct before building complex sequences.

3. **Use constants** - `FieldMap.FIRE_1` catches typos at compile time, `"FIRE_1"` doesn't.

4. **Heading units matter:**
   - `Waypoint.heading` is in **degrees**
   - `Pose2d.heading` is in **radians**
   - `turnTo()` expects **radians**

5. **Alliance reflection** - Only define red waypoints. Blue is automatic. If a waypoint looks wrong for blue, check your red Y-coordinate sign.
